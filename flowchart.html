<script>
    // Khởi tạo Mermaid
    mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        flowchart: {
            useMaxWidth: false,
            htmlLabels: true
        }
    });

    let d3Zoom, svg, g, container;

    function initZoom() {
        svg = d3.select("#flowchart-container svg");
        g = svg.select("g");
        container = d3.select("#flowchart-container");

        d3Zoom = d3.zoom()
            .scaleExtent([0.5, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        container.call(d3Zoom);

        // Reset to identity at start
        svg.call(d3Zoom.transform, d3.zoomIdentity);
    }

    function zoom(delta) {
        if (!svg || !d3Zoom) return;
        // Get current transform
        let t = d3.zoomTransform(g.node());
        let newScale = Math.min(Math.max(0.5, t.k + delta), 3);

        // Zoom to center
        const center = [
            container.node().clientWidth / 2,
            container.node().clientHeight / 2
        ];

        // Compute new transform
        let newTransform = d3.zoomIdentity
            .translate(center[0], center[1])
            .scale(newScale)
            .translate(-center[0], -center[1]);

        svg.transition().duration(200).call(d3Zoom.transform, newTransform);
    }

    function resetView() {
        if (!svg || !d3Zoom) return;
        svg.transition().duration(200).call(d3Zoom.transform, d3.zoomIdentity);
    }

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initZoom, 1000);
    });
</script>
