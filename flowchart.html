<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowchart Thống kê Tâm lý học</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #flowchart-container {
            width: 100%;
            height: 80vh;
            border: 1px solid #ddd;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        .controls {
            margin: 15px 0;
            text-align: center;
        }
        button {
            padding: 8px 15px;
            margin: 0 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Lưu đồ Chọn Kiểm định Thống kê trong Tâm lý học</h1>
    
    <div class="controls">
        <button id="zoom-in">Zoom In (+)</button>
        <button id="zoom-out">Zoom Out (-)</button>
        <button id="reset">Reset</button>
        <button id="fit">Fit to Screen</button>
    </div>
    
    <div id="flowchart-container"></div>

    <!-- Load thư viện -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        // Khởi tạo Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // Định nghĩa flowchart
        const graphDefinition = `
flowchart TD
    Start([Start: Xác định mục tiêu nghiên cứu])
    TypeQ{"Câu hỏi nghiên cứu là gì?"}
    Correlate[Kiểm tra tương quan]
    Compare[So sánh nhóm]
    
    %% Nhánh tương quan
    CorType{"Thang đo của biến?"}
    Pearson[Pearson r]
    Spearman[Spearman rho]
    
    %% Nhánh so sánh
    GroupNum{"Số nhóm cần so sánh?"}
    OneGroup[1 nhóm]
    TwoGroups[2 nhóm]
    ThreeGroups[3+ nhóm]
    
    %% 1 nhóm
    OneSampleT[One-sample t-test]
    Wilcoxon1[Wilcoxon signed-rank]
    
    %% 2 nhóm
    TwoGroupType{"Nhóm độc lập hay phối hợp?"}
    IndepT[Independent t-test]
    PairedT[Paired t-test]
    MannWhitney[Mann-Whitney U]
    Wilcoxon2[Wilcoxon signed-rank]
    
    %% 3+ nhóm
    MultiGroupType{"Nhóm độc lập hay phối hợp?"}
    ANOVA[One-way ANOVA]
    RepeatedANOVA[Repeated ANOVA]
    Kruskal[Kruskal-Wallis]
    Friedman[Friedman test]
    
    %% Kết nối
    Start --> TypeQ
    TypeQ -->|Mối quan hệ| Correlate
    TypeQ -->|Khác biệt| Compare
    
    Correlate --> CorType
    CorType -->|Khoảng/tỉ lệ| Pearson
    CorType -->|Thứ bậc| Spearman
    
    Compare --> GroupNum
    GroupNum -->|1| OneGroup
    OneGroup -->|Parametric| OneSampleT
    OneGroup -->|Non-parametric| Wilcoxon1
    
    GroupNum -->|2| TwoGroups
    TwoGroups --> TwoGroupType
    TwoGroupType -->|Độc lập| IndepT
    TwoGroupType -->|Phối hợp| PairedT
    IndepT -->|Non-parametric| MannWhitney
    PairedT -->|Non-parametric| Wilcoxon2
    
    GroupNum -->|3+| ThreeGroups
    ThreeGroups --> MultiGroupType
    MultiGroupType -->|Độc lập| ANOVA
    MultiGroupType -->|Phối hợp| RepeatedANOVA
    ANOVA -->|Non-parametric| Kruskal
    RepeatedANOVA -->|Non-parametric| Friedman
    
    %% Định dạng
    class Start start
    class TypeQ,CorType,GroupNum,TwoGroupType,MultiGroupType decision
    class Correlate,Compare,Pearson,Spearman,OneGroup,TwoGroups,ThreeGroups,OneSampleT,Wilcoxon1,IndepT,PairedT,MannWhitney,Wilcoxon2,ANOVA,RepeatedANOVA,Kruskal,Friedman process
    
    classDef start fill:#2ecc71,stroke:#27ae60,color:white
    classDef decision fill:#3498db,stroke:#2980b9,color:white
    classDef process fill:#9b59b6,stroke:#8e44ad,color:white
`;

        // Render đồ thị
        const renderFlowchart = async () => {
            const { svg } = await mermaid.mermaidAPI.render('mermaid-svg', graphDefinition);
            document.getElementById('flowchart-container').innerHTML = svg;
            initZoom();
        };

        // Khởi tạo zoom và drag
        const initZoom = () => {
            const container = d3.select("#flowchart-container");
            const svg = d3.select("#flowchart-container svg");
            const inner = svg.select("g");
            
            // Tính toán kích thước ban đầu
            const bbox = inner.node().getBBox();
            const width = bbox.width;
            const height = bbox.height;
            const containerWidth = container.node().clientWidth;
            const containerHeight = container.node().clientHeight;
            
            // Tỉ lệ zoom ban đầu
            const initialScale = Math.min(
                containerWidth / (width + 100),
                containerHeight / (height + 100)
            );
            
            // Vị trí ban đầu
            const initialX = containerWidth/2 - (width/2 + bbox.x) * initialScale;
            const initialY = containerHeight/2 - (height/2 + bbox.y) * initialScale;
            
            let transform = d3.zoomIdentity
                .translate(initialX, initialY)
                .scale(initialScale);
            
            inner.attr("transform", transform);

            // Thiết lập zoom
            const zoom = d3.zoom()
                .scaleExtent([0.2, 5])
                .on("zoom", (event) => {
                    transform = event.transform;
                    inner.attr("transform", transform);
                });

            svg.call(zoom)
               .call(zoom.transform, transform);

            // Các nút điều khiển
            document.getElementById("zoom-in").onclick = () => {
                zoom.scaleBy(svg.transition().duration(300), 1.2);
            };
            
            document.getElementById("zoom-out").onclick = () => {
                zoom.scaleBy(svg.transition().duration(300), 0.8);
            };
            
            document.getElementById("reset").onclick = () => {
                svg.transition()
                   .duration(300)
                   .call(zoom.transform, d3.zoomIdentity
                       .translate(initialX, initialY)
                       .scale(initialScale));
            };
            
            document.getElementById("fit").onclick = () => {
                const currentBBox = inner.node().getBBox();
                const newScale = Math.min(
                    containerWidth / (currentBBox.width + 100),
                    containerHeight / (currentBBox.height + 100)
                );
                const newX = containerWidth/2 - (currentBBox.width/2 + currentBBox.x) * newScale;
                const newY = containerHeight/2 - (currentBBox.height/2 + currentBBox.y) * newScale;
                
                svg.transition()
                   .duration(300)
                   .call(zoom.transform, d3.zoomIdentity
                       .translate(newX, newY)
                       .scale(newScale));
            };
        };

        // Bắt đầu render
        renderFlowchart();
    </script>
</body>
</html>