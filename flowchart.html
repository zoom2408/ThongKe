<script>
    mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        flowchart: {
            useMaxWidth: false,
            htmlLabels: true
        }
    });

    let scale = 1;
    let transform = d3.zoomIdentity;
    let zoomBehavior;

    function getSvgAndGroup() {
        const svg = d3.select("#flowchart-container svg");
        // Mermaid puts the graph in the first <g> inside <svg>
        const g = svg.select("g");
        return {svg, g};
    }

    function initZoom() {
        const {svg, g} = getSvgAndGroup();
        if (svg.empty() || g.empty()) return;

        zoomBehavior = d3.zoom()
            .scaleExtent([0.5, 3])
            .on("zoom", (event) => {
                transform = event.transform;
                g.attr("transform", transform);
                scale = transform.k;
            });

        svg.call(zoomBehavior);

        // Optional: set initial transform to identity
        g.attr("transform", d3.zoomIdentity);
    }

    function zoom(delta) {
        scale += delta;
        scale = Math.min(Math.max(0.5, scale), 3);

        const {svg, g} = getSvgAndGroup();
        if (svg.empty() || g.empty()) return;

        // Center zoom on the middle of the container
        const container = document.getElementById("flowchart-container");
        const centerX = container.clientWidth / 2;
        const centerY = container.clientHeight / 2;

        transform = d3.zoomIdentity
            .translate(centerX, centerY)
            .scale(scale)
            .translate(-centerX, -centerY);

        g.attr("transform", transform);

        // Update D3 zoom's internal state
        svg.call(zoomBehavior.transform, transform);
    }

    function resetView() {
        scale = 1;
        transform = d3.zoomIdentity;

        const {svg, g} = getSvgAndGroup();
        if (svg.empty() || g.empty()) return;

        g.attr("transform", transform);
        svg.call(zoomBehavior.transform, transform);
    }

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initZoom, 1000);
    });
</script>
